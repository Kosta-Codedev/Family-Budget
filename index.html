<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×ª×§×¦×™×‘ ××©×¤×—×ª×™</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.rtl.min.css" integrity="sha384-DOXMLfHhQkvFFp+rWTZwVlPVqdIhpDVYT9csOnHSgWQWPX0v5MCGtjCJbY6ERspU" crossorigin="anonymous">    
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #073B4C; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .balance-card { color: white; }
        .bg-balance { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .table-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { font-weight: 700; color: #333; }
        #auth-section { height: 100vh; display: flex; align-items: center; justify-content: center; background: #e9ecef; }
        
        /* --- ×”×ª×™×§×•×Ÿ ×œ×¨×™×¦×•×“ --- */
        .chart-container {
            position: relative;
            height: 300px !important; /* ×’×•×‘×” ×§×‘×•×¢ ×‘×›×•×— */
            width: 100%;
            overflow: hidden; /* ××•× ×¢ ×’×œ×™×©×” ×”×—×•×¦×” */
        }
    </style>
</head>
<body>

    <div id="auth-section">
        <div class="text-center">
            <h1 class="mb-4">ğŸ’° ×”××¢×¨×›×ª ×©×œ ×§×•×¡×˜×”</h1>
            <button class="btn btn-primary btn-lg px-5 shadow" onclick="handleAuthClick()">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="20" style="margin-left:10px;">
                ×”×ª×—×‘×¨ ×¢× Google
            </button>
        </div>
    </div>

    <div id="app-section" class="container py-4" style="display: none;">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>SheetsBudget ğŸ“Š</h3>
            <button class="btn btn-outline-danger btn-sm" onclick="handleSignoutClick()">×™×¦×™××”</button>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <select id="monthFilter" class="form-select" onchange="filterData()">
                    <option value="all">×”×¦×’ ×”×›×œ</option>
                </select>
            </div>
        </div>

        <div class="row text-center">
            <div class="col-md-4">
                <div class="card balance-card" style="background: #073B4C;">
                    <div class="card-body">
                        <h5>×”×•×¦××•×ª</h5>
                        <h2 id="total-expense">â‚ª0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card balance-card" style="background: #4ecdc4;">
                    <div class="card-body">
                        <h5>×”×›× ×¡×•×ª</h5>
                        <h2 id="total-income">â‚ª0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card balance-card bg-balance">
                    <div class="card-body">
                        <h5>×™×ª×¨×”</h5>
                        <h2 id="total-balance">â‚ª0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª</h5>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center">××’××” ×—×•×“×©×™×ª</h5>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div> -->
        </div>

        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card p-3">
                    <h5 class="mb-3">×”×–× ×ª × ×ª×•× ×™×</h5>
                    <form id="budget-form" onsubmit="handleFormSubmit(event)">
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="type" id="type-expense" value="×”×•×¦××”" checked>
                            <label class="btn btn-outline-danger" for="type-expense">×”×•×¦××”</label>
                            <input type="radio" class="btn-check" name="type" id="type-income" value="×”×›× ×¡×”">
                            <label class="btn btn-outline-primary" for="type-income">×”×›× ×¡×”</label>
                        </div>
                        <input type="text" class="form-control mb-2" id="description" placeholder="×ª×™××•×¨">
                        <select class="form-select mb-2" id="category">
                            <option>×¡×•×¤×¨</option>
                            <option>×—×©×‘×•× ×•×ª</option>
                            <option>×‘×™×œ×•×™×™×</option>
                            <option>×¨×›×‘</option>
                            <option>××©×›× ×ª×/×©×›×™×¨×•×ª</option>
                            <option>×‘×™×’×•×“</option>
                            <option>××•×›×œ ×‘×—×•×¥</option>
                            <option>×©×•× ×•×ª</option>
                            <option>××©×›×•×¨×ª</option>
                        </select>
                        <input type="number" class="form-control mb-2" id="amount" placeholder="×¡×›×•×" required>
                        <input type="date" class="form-control mb-3" id="date" required>
                        <button type="submit" class="btn btn-success w-100">×©××•×¨</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="table-container">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover">
                            <thead class="table-light sticky-top">
                                <tr><th>×ª××¨×™×š</th><th>×ª×™××•×¨</th><th>×§×˜×’×•×¨×™×”</th><th>×¡×›×•×</th></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- ×”×’×“×¨×•×ª (××œ× ××ª ×–×” ×‘×©×œ×‘ ×”×‘×) ---
    const CLIENT_ID = '259903743134-c11nd75gj2fm3e558geql9rociuf2svj.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyCiv1M2S8evvEqj786CvTJaztI64hN5_6Q';
    const SPREADSHEET_ID = '1mwPHjuqia7YozE4MUA7Wk2SP1W1SWgCxC1pedX7WQ50';
        
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        let tokenClient;
        let rawData = [];
        let categoryChartInstance = null;
        let monthlyChartInstance = null;

        // ×˜×¢×™× ×ª ×’×•×’×œ
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error) return;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('app-section').style.display = 'block';
                    loadData();
                },
            });
        }
        function handleAuthClick() { tokenClient.requestAccessToken({prompt: 'consent'}); }
        function handleSignoutClick() { 
            const token = gapi.client.getToken();
            if (token) google.accounts.oauth2.revoke(token.access_token);
            location.reload();
        }

        // ×˜×¢×™× ×ª × ×ª×•× ×™×
        async function loadData() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID, range: 'Sheet1!A2:E'
                });
                const rows = response.result.values || [];
                rawData = rows.map(row => ({
                    date: row[0] || '',
                    desc: row[1] || '',
                    category: row[2] || '',
                    amount: parseFloat((row[3] || '0').replace(/[â‚ª,]/g, '')),
                    type: row[4] || '×”×•×¦××”'
                })).filter(item => item.date);
                
                populateMonthFilter();
                filterData();
            } catch (err) { console.error(err); }
        }

        // ×©××™×¨×ª × ×ª×•× ×™×
        async function handleFormSubmit(e) {
            e.preventDefault();
            const date = new Date(document.getElementById('date').value).toLocaleDateString('en-GB');
            const values = [[
                date,
                document.getElementById('description').value,
                document.getElementById('category').value,
                document.getElementById('amount').value,
                document.querySelector('input[name="type"]:checked').value
            ]];
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: SPREADSHEET_ID, range: 'Sheet1!A:E',
                valueInputOption: 'USER_ENTERED', resource: { values: values }
            });
            document.getElementById('budget-form').reset();
            document.getElementById('date').valueAsDate = new Date();
            loadData();
        }

        // × ×™×”×•×œ ×¤×™×œ×˜×¨×™× ×•×’×¨×¤×™×
        function populateMonthFilter() {
            const filter = document.getElementById('monthFilter');
            const currentVal = filter.value;
            const months = new Set();
            rawData.forEach(item => {
                const parts = item.date.split('/');
                if(parts.length === 3) months.add(`${parts[1]}/${parts[2]}`);
            });
            filter.innerHTML = '<option value="all">×”×¦×’ ×”×›×œ</option>';
            Array.from(months).sort().reverse().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m; filter.appendChild(opt);
            });
            filter.value = currentVal;
        }

        function filterData() {
            const selectedMonth = document.getElementById('monthFilter').value;
            let filtered = rawData;
            if (selectedMonth !== 'all') filtered = rawData.filter(item => item.date.includes(selectedMonth));
            
            renderTable(filtered);
            updateCards(filtered);
            updateCharts(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            data.sort((a, b) => b.date.split('/').reverse().join('').localeCompare(a.date.split('/').reverse().join('')))
                .forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${row.date}</td><td>${row.desc}</td><td>${row.category}</td>
                                    <td class="${row.type === '×”×›× ×¡×”'?'text-success':'text-danger'}">â‚ª${row.amount.toLocaleString()}</td>`;
                    tbody.appendChild(tr);
                });
        }

        function updateCards(data) {
            let income = 0, expense = 0;
            data.forEach(d => d.type === '×”×›× ×¡×”' ? income += d.amount : expense += d.amount);
            document.getElementById('total-income').innerText = `â‚ª${income.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `â‚ª${expense.toLocaleString()}`;
            document.getElementById('total-balance').innerText = `â‚ª${(income - expense).toLocaleString()}`;
        }

        function updateCharts(data) {
            // ×”×›× ×ª × ×ª×•× ×™× ×œ×’×¨×£ ×¢×•×’×”
            const expensesByCategory = {};
            data.filter(d => d.type === '×”×•×¦××”').forEach(d => expensesByCategory[d.category] = (expensesByCategory[d.category] || 0) + d.amount);
            
            const ctxPie = document.getElementById('categoryChart').getContext('2d');
            if (categoryChartInstance) categoryChartInstance.destroy();
            categoryChartInstance = new Chart(ctxPie, {
                type: 'pie', // ×¢×•×’×” ×¨×’×™×œ×”
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{ data: Object.values(expensesByCategory), backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'] }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, // ×—×•×‘×” ×›×“×™ ×œ×× ×•×¢ ×¨×™×¦×•×“!
                }
            });

            // // ×”×›× ×ª × ×ª×•× ×™× ×œ×’×¨×£ ×¢××•×“×•×ª
            // const monthlyTrend = {};
            // data.forEach(d => {
            //     const m = d.date.split('/').slice(1).join('/');
            //     if (!monthlyTrend[m]) monthlyTrend[m] = { income: 0, expense: 0 };
            //     d.type === '×”×›× ×¡×”' ? monthlyTrend[m].income += d.amount : monthlyTrend[m].expense += d.amount;
            // });

            // const ctxBar = document.getElementById('monthlyChart').getContext('2d');
            // if (monthlyChartInstance) monthlyChartInstance.destroy();
            // const sortedMonths = Object.keys(monthlyTrend).sort((a,b) => a.split('/').reverse().join('').localeCompare(b.split('/').reverse().join('')));
            
            // monthlyChartInstance = new Chart(ctxBar, {
            //     type: 'bar',
            //     data: {
            //         labels: sortedMonths,
            //         datasets: [
            //             { label: '×”×›× ×¡×•×ª', data: sortedMonths.map(m => monthlyTrend[m].income), backgroundColor: '#4bc0c0' },
            //             { label: '×”×•×¦××•×ª', data: sortedMonths.map(m => monthlyTrend[m].expense), backgroundColor: '#ff6384' }
            //         ]
            //     },
            //     options: { 
            //         responsive: true, 
            //         maintainAspectRatio: false, // ×—×•×‘×” ×›×“×™ ×œ×× ×•×¢ ×¨×™×¦×•×“!
            //         scales: { y: { beginAtZero: true } }
            //     }
            // });
        }
        
        document.getElementById('date').valueAsDate = new Date();
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>