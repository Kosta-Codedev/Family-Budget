<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×ª×§×¦×™×‘ ××©×¤×—×ª×™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .balance-card { color: white; }
        .bg-income { background: linear-gradient(45deg, #4b6cb7, #182848); }
        .bg-expense { background: linear-gradient(45deg, #ef32d9, #89fffd); background-color: #ff416c; background-image: linear-gradient(315deg, #ff416c 0%, #ff4b2b 74%); }
        .bg-balance { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .table-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { font-weight: 700; color: #333; }
        #auth-section { height: 100vh; display: flex; align-items: center; justify-content: center; background: #e9ecef; }
    </style>
</head>
<body>

    <div id="auth-section">
        <div class="text-center">
            <h1 class="mb-4">ğŸ’° ×”××¢×¨×›×ª ×©×œ ×§×•×¡×˜×”</h1>
            <p class="mb-4">× ×™×”×•×œ ×ª×§×¦×™×‘ ×—×›×, ×¤×©×•×˜ ×•×××•×‘×˜×—.</p>
            <button class="btn btn-primary btn-lg px-5 shadow" onclick="handleAuthClick()">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="20" style="margin-left:10px;">
                ×”×ª×—×‘×¨ ×¢× Google
            </button>
        </div>
    </div>

    <div id="app-section" class="container py-4" style="display: none;">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>SheetsBudget ğŸ“Š</h3>
            <div>
                <span id="user-email" class="me-3 text-muted" style="font-size: 0.9em;"></span>
                <button class="btn btn-outline-danger btn-sm" onclick="handleSignoutClick()">×™×¦×™××”</button>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <select id="monthFilter" class="form-select" onchange="filterData()">
                    <option value="all">×”×¦×’ ×”×›×œ</option>
                    </select>
            </div>
        </div>

        <div class="row text-center">
            <div class="col-md-4">
                <div class="card balance-card" style="background: #ff6b6b;">
                    <div class="card-body">
                        <h5>×”×•×¦××•×ª</h5>
                        <h2 id="total-expense">â‚ª0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card balance-card" style="background: #4ecdc4;">
                    <div class="card-body">
                        <h5>×”×›× ×¡×•×ª</h5>
                        <h2 id="total-income">â‚ª0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card balance-card bg-balance">
                    <div class="card-body">
                        <h5>×™×ª×¨×”</h5>
                        <h2 id="total-balance">â‚ª0</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center">×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª (×§×˜×’×•×¨×™×•×ª)</h5>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title text-center">××’××” ×—×•×“×©×™×ª</h5>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card p-3">
                    <h5 class="mb-3">×”×•×¡×¤×ª ×©×•×¨×” ×œ×©×™×˜×¡</h5>
                    <form id="budget-form" onsubmit="handleFormSubmit(event)">
                        <div class="btn-group w-100 mb-3" role="group">
                            <input type="radio" class="btn-check" name="type" id="type-expense" value="×”×•×¦××”" checked>
                            <label class="btn btn-outline-danger" for="type-expense">×”×•×¦××”</label>
                            <input type="radio" class="btn-check" name="type" id="type-income" value="×”×›× ×¡×”">
                            <label class="btn btn-outline-primary" for="type-income">×”×›× ×¡×”</label>
                        </div>

                        <div class="mb-2">
                            <input type="text" class="form-control" id="description" placeholder="×ª×™××•×¨ (×œ××©×œ: ×¡×•×¤×¨)" required>
                        </div>
                        
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <select class="form-select" id="category">
                                    <option>×¡×•×¤×¨</option>
                                    <option>×—×©×‘×•× ×•×ª</option>
                                    <option>×‘×™×œ×•×™×™×</option>
                                    <option>×¨×›×‘</option>
                                    <option>××©×›× ×ª×/×©×›×™×¨×•×ª</option>
                                    <option>×‘×™×’×•×“</option>
                                    <option>××•×›×œ ×‘×—×•×¥</option>
                                    <option>×©×•× ×•×ª</option>
                                    <option>××©×›×•×¨×ª</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <input type="number" class="form-control" id="amount" placeholder="×¡×›×•×" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <input type="date" class="form-control" id="date" required>
                        </div>

                        <button type="submit" class="btn btn-success w-100 fw-bold">×©××•×¨ ×‘-Sheets</button>
                    </form>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="table-container">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="m-0">× ×ª×•× ×™× ××”×’×™×œ×™×•×Ÿ (Live)</h5>
                        <small id="status-msg" class="text-muted">×˜×•×¢×Ÿ...</small>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>×ª××¨×™×š</th>
                                    <th>×ª×™××•×¨</th>
                                    <th>×§×˜×’×•×¨×™×”</th>
                                    <th>×¡×›×•×</th>
                                    <th>×¡×•×’</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
      const CLIENT_ID = '259903743134-c11nd75gj2fm3e558geql9rociuf2svj.apps.googleusercontent.com'; 
    const API_KEY = 'AIzaSyCiv1M2S8evvEqj786CvTJaztI64hN5_6Q';
    const SPREADSHEET_ID = '1mwPHjuqia7YozE4MUA7Wk2SP1W1SWgCxC1pedX7WQ50'; // ×”××–×”×” ××”-URL ×©×œ ×”×©×™×˜×¡
    
        
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let rawData = []; // ×œ×©××™×¨×ª ×”× ×ª×•× ×™× ×”×’×•×œ××™×™×
        let categoryChartInstance = null;
        let monthlyChartInstance = null;

        // ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª ×’×•×’×œ
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"] });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('app-section').style.display = 'block';
                    loadData();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                // ×”××¢×¨×›×ª ××•×›× ×”
                // ×‘×“×™×§×” ×× ×›×‘×¨ ××—×•×‘×¨ (××•×¤×¦×™×•× ×œ×™, ×›××Ÿ × ×©××™×¨ ×¤×©×•×˜)
            }
        }

        function handleAuthClick() {
            tokenClient.requestAccessToken({prompt: 'consent'});
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('app-section').style.display = 'none';
            }
        }

        // --- ×œ×•×’×™×§×” ×¢×¡×§×™×ª ---

        async function loadData() {
            document.getElementById('status-msg').innerText = '×˜×•×¢×Ÿ × ×ª×•× ×™×...';
            try {
                // ×§×¨×™××ª × ×ª×•× ×™× ×-Sheet1
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A2:E', // ×× ×™×— ×©×™×© ×›×•×ª×¨×•×ª ×‘×©×•×¨×” 1
                });

                const rows = response.result.values;
                if (!rows || rows.length === 0) {
                    document.getElementById('status-msg').innerText = '××™×Ÿ × ×ª×•× ×™× ×‘×’×™×œ×™×•×Ÿ.';
                    rawData = [];
                } else {
                    // ×”××¨×ª ×”× ×ª×•× ×™× ×œ××•×‘×™×™×§×˜×™× × ×•×—×™×
                    rawData = rows.map(row => ({
                        date: row[0] || '',
                        desc: row[1] || '',
                        category: row[2] || '',
                        amount: parseFloat((row[3] || '0').replace(/[â‚ª,]/g, '')),
                        type: row[4] || '×”×•×¦××”'
                    })).filter(item => item.date); // ××¡× ×Ÿ ×©×•×¨×•×ª ×¨×™×§×•×ª
                    
                    document.getElementById('status-msg').innerText = '×¢×•×“×›×Ÿ ×¢×›×©×™×•';
                }
                
                populateMonthFilter();
                filterData(); // ××¦×™×’ ××ª ×”× ×ª×•× ×™× (×›×•×œ×œ ×’×¨×¤×™×)

            } catch (err) {
                console.error(err);
                document.getElementById('status-msg').innerText = '×©×’×™××” ×‘×˜×¢×™× ×”: ' + err.message;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const date = document.getElementById('date').value; // YYYY-MM-DD
            const desc = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const amount = document.getElementById('amount').value;
            const type = document.querySelector('input[name="type"]:checked').value;

            // ×”××¨×” ×œ×¤×•×¨××˜ ×™×©×¨××œ×™ (DD/MM/YYYY)
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-GB'); // dd/mm/yyyy

            const values = [[formattedDate, desc, category, amount, type]];

            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A:E',
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: values }
                });
                
                // ××™×¤×•×¡ ×˜×•×¤×¡ ×•×¨×¢× ×•×Ÿ
                document.getElementById('budget-form').reset();
                document.getElementById('date').valueAsDate = new Date(); // ×ª××¨×™×š ×©×œ ×”×™×•×
                loadData(); 

            } catch (err) {
                alert('×©×’×™××” ×‘×©××™×¨×”: ' + err.message);
            }
        }

        // --- ×¡×™× ×•×Ÿ ×•×’×¨×¤×™× ---

        function populateMonthFilter() {
            const filter = document.getElementById('monthFilter');
            const currentVal = filter.value;
            
            // ××™×¡×•×£ ×›×œ ×”×—×•×“×©×™× ×”×™×™×—×•×“×™×™× ××”× ×ª×•× ×™×
            const months = new Set();
            rawData.forEach(item => {
                // item.date ×¦×¤×•×™ ×œ×”×™×•×ª DD/MM/YYYY
                const parts = item.date.split('/');
                if(parts.length === 3) {
                    months.add(`${parts[1]}/${parts[2]}`); // MM/YYYY
                }
            });

            // × ×™×§×•×™ ×•×‘× ×™×™×” ××—×“×©
            filter.innerHTML = '<option value="all">×”×¦×’ ×”×›×œ</option>';
            Array.from(months).sort().reverse().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                filter.appendChild(opt);
            });
            
            filter.value = currentVal; // ×©××™×¨×ª ×”×‘×—×™×¨×” ×× ×”×™×™×ª×”
        }

        function filterData() {
            const selectedMonth = document.getElementById('monthFilter').value;
            
            let filtered = rawData;
            if (selectedMonth !== 'all') {
                filtered = rawData.filter(item => item.date.includes(selectedMonth));
            }

            renderTable(filtered);
            updateCards(filtered);
            updateCharts(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š (×—×“×© ×œ×™×©×Ÿ)
            // ×”× ×—×”: ×ª××¨×™×š ×‘×¤×•×¨××˜ DD/MM/YYYY
            const sorted = [...data].sort((a, b) => {
                const da = a.date.split('/').reverse().join('-');
                const db = b.date.split('/').reverse().join('-');
                return db.localeCompare(da);
            });

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                const colorClass = row.type === '×”×›× ×¡×”' ? 'text-success' : 'text-danger';
                tr.innerHTML = `
                    <td>${row.date}</td>
                    <td>${row.desc}</td>
                    <td>${row.category}</td>
                    <td class="${colorClass}" style="direction: ltr; text-align: right;">â‚ª${row.amount.toLocaleString()}</td>
                    <td><span class="badge ${row.type === '×”×›× ×¡×”' ? 'bg-success' : 'bg-danger'}">${row.type}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCards(data) {
            let income = 0;
            let expense = 0;

            data.forEach(d => {
                if (d.type === '×”×›× ×¡×”') income += d.amount;
                else expense += d.amount;
            });

            document.getElementById('total-income').innerText = `â‚ª${income.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `â‚ª${expense.toLocaleString()}`;
            document.getElementById('total-balance').innerText = `â‚ª${(income - expense).toLocaleString()}`;
        }

        function updateCharts(data) {
            // ×”×›× ×ª × ×ª×•× ×™× ×œ×’×¨×£ ×§×˜×’×•×¨×™×•×ª (×¨×§ ×”×•×¦××•×ª)
            const expensesByCategory = {};
            data.filter(d => d.type === '×”×•×¦××”').forEach(d => {
                expensesByCategory[d.category] = (expensesByCategory[d.category] || 0) + d.amount;
            });

            // ×”×›× ×ª × ×ª×•× ×™× ×œ×’×¨×£ ×—×•×“×©×™ (×›×œ ×”×–×× ×™×, ×œ× ××•×©×¤×¢ ××”×¤×™×œ×˜×¨ ×× ×”×•× ×œ× "×”×›×œ")
            // ××‘×œ ×× ×”××©×ª××© ×¡×™× ×Ÿ ×—×•×“×©, × ×¨××” ×¨×§ ××•×ª×•. ×× "×”×›×œ", × ×¨××” ×”×™×¡×˜×•×¨×™×”.
            const monthlyTrend = {};
            // ×©×™××•×© ×‘-rawData ×›×“×™ ×œ×”×¨××•×ª ×ª××™×“ ××ª ×”××’××”, ××• filtered ×›×“×™ ×œ×”×¨××•×ª ×–×•×?
            // × ×œ×š ×¢×œ filtered ×›×“×™ ×©×™×”×™×” ×¢×§×‘×™ ×¢× ×”××¡×š
            data.forEach(d => {
                const m = d.date.split('/').slice(1).join('/'); // MM/YYYY
                if (!monthlyTrend[m]) monthlyTrend[m] = { income: 0, expense: 0 };
                if (d.type === '×”×›× ×¡×”') monthlyTrend[m].income += d.amount;
                else monthlyTrend[m].expense += d.amount;
            });

            // ×¦×™×•×¨ ×’×¨×£ ×¢×•×’×” (×§×˜×’×•×¨×™×•×ª)
            const ctxPie = document.getElementById('categoryChart').getContext('2d');
            if (categoryChartInstance) categoryChartInstance.destroy();
            
            categoryChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(expensesByCategory),
                    datasets: [{
                        data: Object.values(expensesByCategory),
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf', '#2ecc71']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // ×¦×™×•×¨ ×’×¨×£ ×¢××•×“×•×ª (×—×•×“×©×™×)
            const ctxBar = document.getElementById('monthlyChart').getContext('2d');
            if (monthlyChartInstance) monthlyChartInstance.destroy();

            // ×¡×™×“×•×¨ ×—×•×“×©×™× ×›×¨×•× ×•×œ×•×’×™
            const sortedMonths = Object.keys(monthlyTrend).sort((a,b) => {
                const [m1, y1] = a.split('/');
                const [m2, y2] = b.split('/');
                return (y1 + m1) - (y2 + m2);
            });

            monthlyChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        { label: '×”×›× ×¡×•×ª', data: sortedMonths.map(m => monthlyTrend[m].income), backgroundColor: '#4bc0c0' },
                        { label: '×”×•×¦××•×ª', data: sortedMonths.map(m => monthlyTrend[m].expense), backgroundColor: '#ff6384' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        // ×”×’×“×¨×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ×ª××¨×™×š ×”×™×•× ×‘×˜×•×¤×¡
        document.getElementById('date').valueAsDate = new Date();

    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>